<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScrapPro - Professional Accountant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .card { background: white; border-radius: 20px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05); border: 1px solid #f1f5f9; }
        .input-field { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 12px; width: 100%; outline: none; transition: all 0.2s; }
        .input-field:focus { border-color: #6366f1; background: white; ring: 2px solid #6366f120; }
        .btn-primary { background: #4f46e5; color: white; padding: 12px; border-radius: 12px; font-weight: 700; transition: all 0.2s; cursor: pointer; }
        .btn-primary:hover { background: #4338ca; transform: translateY(-1px); }
        .tab-btn { font-weight: 700; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; padding: 8px 16px; border-radius: 8px; color: #94a3b8; }
        .tab-btn.active { color: #4f46e5; background: #eef2ff; }
        #pdfExportContent, #expensePDFContent { padding: 40px; border-radius: 24px; position: relative; background: white; }
        .statement-header { border-top: 8px solid #6366f1; border-radius: 24px 24px 0 0; }
        .table-head { background: #f8fafc; border-radius: 12px; }
        @media print { .no-print { display: none !important; } }
        .hidden { display: none !important; }
        .pdf-hide { display: none !important; }
    </style>
</head>
<body class="min-h-screen pb-12">

    <div id="auth-screen" class="fixed inset-0 z-[100] bg-slate-50 flex items-center justify-center p-4">
        <div class="card p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <span class="text-2xl font-extrabold text-indigo-600 tracking-tighter italic">ScrapPro</span>
                <p id="auth-title" class="text-slate-400 font-bold text-sm mt-2 uppercase tracking-widest">Login to Account</p>
            </div>
            <div class="space-y-4">
                <input type="text" id="auth-user" placeholder="Username" class="input-field">
                <input type="password" id="auth-pass" placeholder="Password" class="input-field">
                <button onclick="handleAuth()" id="auth-btn" class="w-full btn-primary">Login</button>
                <p class="text-center text-xs font-bold text-slate-400">
                    <span id="auth-toggle-text">Don't have an account?</span> 
                    <button onclick="toggleAuthMode()" class="text-indigo-600 underline" id="auth-toggle-btn">Register</button>
                </p>
            </div>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <nav class="bg-white border-b sticky top-0 z-50 mb-8">
            <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                <div class="flex items-center gap-8">
                    <span class="text-xl font-extrabold text-indigo-600 tracking-tighter italic">ScrapPro</span>
                    <div class="flex gap-2">
                        <button id="tab-calc" onclick="switchTab('calc')" class="tab-btn active">Calculator</button>
                        <button id="tab-ledger" onclick="switchTab('ledger')" class="tab-btn">Monthly Expenses</button>
                        <button id="tab-parties" onclick="switchTab('parties')" class="tab-btn">Parties Ledger</button>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <select id="currency-select" onchange="updateCurrency()" class="text-xs font-bold bg-slate-100 p-2 rounded-lg outline-none border-none">
                        <option value="$">$ (USD)</option>
                        <option value="PKR">PKR</option>
                        <option value="₹">₹ (INR)</option>
                        <option value="€">€ (EUR)</option>
                        <option value="£">£ (GBP)</option>
                    </select>
                    <button onclick="logout()" class="text-slate-400 hover:text-rose-500"><i class="fas fa-power-off"></i></button>
                </div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto px-4">
            <div id="view-calc" class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <div class="lg:col-span-4 space-y-6">
                    <div class="card p-6 border-t-4 border-indigo-500">
                        <h3 class="text-[11px] font-bold text-slate-400 uppercase mb-4 flex items-center gap-2">
                            <i class="fas fa-shopping-cart text-indigo-500"></i> Raw Material Purchase
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Input Weight (kg)</label>
                                <input type="number" id="rawWeight" oninput="calculate()" class="input-field mt-1" placeholder="0.00">
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Buy Rate /kg</label>
                                <input type="number" id="rawRate" oninput="calculate()" class="input-field mt-1" placeholder="Rate">
                            </div>
                        </div>
                    </div>
                    <div class="card p-6 border-t-4 border-orange-400">
                        <h3 class="text-[11px] font-bold text-slate-400 uppercase mb-4 flex items-center gap-2">
                            <i class="fas fa-tools text-orange-400"></i> Processing Costs
                        </h3>
                        <div class="flex bg-slate-100 p-1 rounded-xl mb-4 text-[10px] font-bold">
                            <button id="btnKg" onclick="setLaborMode('kg')" class="flex-1 py-2 rounded-lg bg-white shadow-sm text-indigo-600">PER KG</button>
                            <button id="btnFixed" onclick="setLaborMode('fixed')" class="flex-1 py-2 rounded-lg text-slate-500">FIXED FEE</button>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label id="laborLabel" class="text-[10px] font-bold text-slate-400 uppercase ml-1">Labor (/kg)</label>
                                <input type="number" id="laborInput" oninput="calculate()" class="input-field mt-1">
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Transport</label>
                                <input type="number" id="transport" oninput="calculate()" class="input-field mt-1">
                            </div>
                        </div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Other (Chai, Elec, etc)</label>
                        <input type="number" id="misc" oninput="calculate()" class="input-field mt-1">
                    </div>
                </div>

                <div class="lg:col-span-8 space-y-6">
                    <div class="card p-6 border-t-4 border-emerald-500">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-[11px] font-bold text-slate-400 uppercase flex items-center gap-2">
                                <i class="fas fa-tags text-emerald-500"></i> Recovery & Sales
                            </h3>
                            <button onclick="addProductRow()" class="text-[10px] font-bold text-emerald-600 bg-emerald-50 px-3 py-1.5 rounded-lg hover:bg-emerald-100">+ Add Product</button>
                        </div>
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="text-left text-slate-400 text-[11px] font-bold uppercase">
                                    <th class="pb-4">Material Name</th>
                                    <th class="pb-4">Weight (kg)</th>
                                    <th class="pb-4">Sell Rate/kg</th>
                                    <th class="pb-4 text-right">Total</th>
                                </tr>
                            </thead>
                            <tbody id="salesBody"></tbody>
                        </table>
                        <div class="mt-6 pt-6 border-t flex justify-between items-center">
                            <span class="font-bold text-slate-800">Total Sales Recovery:</span>
                            <span id="grandTotalSales" class="text-2xl font-black text-emerald-600">0.00</span>
                        </div>
                    </div>

                    <div class="card p-8 text-center bg-slate-50/50">
                        <div class="grid grid-cols-4 gap-4 mb-8">
                            <div><p class="text-[10px] font-bold text-slate-400 uppercase">Weight Balance</p><p id="weightStats" class="font-bold">0 / 0 kg</p></div>
                            <div><p class="text-[10px] font-bold text-slate-400 uppercase">Total Cost</p><p id="displayCost" class="font-bold">0</p></div>
                            <div><p class="text-[10px] font-bold text-slate-400 uppercase">Wastage</p><p id="wasteText" class="font-bold text-rose-500">0%</p></div>
                            <div><p class="text-[10px] font-bold text-slate-400 uppercase">Profit %</p><p id="marginText" class="font-bold text-emerald-500">0%</p></div>
                        </div>
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Final Net Result</p>
                        <h2 id="finalProfit" class="text-7xl font-black text-slate-200">0.00</h2>
                        <div id="statusTag" class="inline-block mt-4 px-4 py-1 rounded-full text-[10px] font-black uppercase bg-slate-200 text-slate-500">No Data</div>
                    </div>
                </div>
            </div>

            <div id="view-ledger" class="hidden grid grid-cols-1 lg:grid-cols-12 gap-8">
                <div class="lg:col-span-4">
                    <div class="card p-6 sticky top-24">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-slate-800">ADD DAILY EXPENSE</h3>
                        </div>
                        <div class="space-y-4">
                            <input type="date" id="expDate" class="input-field">
                            <input type="text" id="expTitle" placeholder="What did you spend on?" class="input-field">
                            <input type="number" id="expAmount" placeholder="Amount" class="input-field">
                            <button id="saveExpBtn" onclick="addExpense()" class="w-full btn-primary bg-slate-900">Save Expense</button>
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-8 space-y-6" id="ledgerList"></div>
            </div>

            <div id="view-parties" class="hidden space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="card p-6 border-l-4 border-emerald-500">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">Receivables</p>
                        <h3 id="statReceivable" class="text-2xl font-black text-emerald-600">0</h3>
                    </div>
                    <div class="card p-6 border-l-4 border-rose-500">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">Payables</p>
                        <h3 id="statPayable" class="text-2xl font-black text-rose-600">0</h3>
                    </div>
                    <div class="card p-6 border-l-4 border-indigo-500">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">Net Balance</p>
                        <h3 id="statNet" class="text-2xl font-black text-slate-800">0</h3>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                    <div class="lg:col-span-4">
                        <div class="card p-6 border-t-4 border-indigo-600 sticky top-24">
                            <h3 id="entryFormTitle" class="text-[10px] font-black text-slate-400 uppercase mb-4">Add New Entry</h3>
                            <div class="space-y-4">
                                <input type="date" id="transDate" class="input-field">
                                <select id="transRole" class="input-field"><option>Customer</option><option>Buyer</option></select>
                                <input type="text" id="transName" placeholder="Full Name" class="input-field">
                                <div class="flex gap-2">
                                    <button onclick="setTransType('credit')" id="typeCredit" class="flex-1 py-3 rounded-xl font-bold bg-emerald-500 text-white">CREDIT</button>
                                    <button onclick="setTransType('debit')" id="typeDebit" class="flex-1 py-3 rounded-xl font-bold border-2 border-rose-500 text-rose-500">DEBIT</button>
                                </div>
                                <input type="number" id="transAmount" placeholder="Amount" class="input-field">
                                <input type="text" id="transNote" placeholder="Note (Optional)" class="input-field">
                                <button id="saveTransBtn" onclick="addTransaction()" class="w-full btn-primary shadow-lg shadow-indigo-200">Save Entry</button>
                                <button id="cancelTransEdit" onclick="resetTransForm()" class="hidden w-full text-slate-400 font-bold text-xs uppercase mt-2">Cancel Edit</button>
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-8">
                        <div id="partyListView">
                            <input type="text" id="searchParty" oninput="renderParties()" placeholder="Search Name..." class="input-field mb-4 bg-white shadow-sm">
                            <div id="partiesContainer" class="space-y-3"></div>
                        </div>

                        <div id="partyDetailView" class="hidden">
                            <div class="flex justify-between items-center mb-4">
                                <button onclick="backToParties()" class="text-indigo-600 font-bold text-sm flex items-center gap-2"><i class="fas fa-arrow-left"></i> Back to All</button>
                                <button onclick="downloadPDF()" class="btn-primary px-6 text-xs uppercase shadow-xl"><i class="fas fa-file-pdf mr-2"></i> Download PDF</button>
                            </div>
                            
                            <div id="pdfExportContent" class="card overflow-hidden">
                                <div class="statement-header p-8 pb-4">
                                    <p class="text-[11px] font-bold text-indigo-500 uppercase tracking-widest mb-4">Account Statement</p>
                                    <div class="flex justify-between items-end">
                                        <div>
                                            <span id="detRole" class="bg-slate-100 text-slate-500 text-[10px] px-2 py-0.5 rounded font-bold uppercase tracking-wider">CUSTOMER</span>
                                            <h2 id="detName" class="text-5xl font-black text-slate-800 mt-2 tracking-tight">NAME</h2>
                                        </div>
                                        <div class="text-right pb-1">
                                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Current Balance</p>
                                            <h3 id="detBalance" class="text-3xl font-black text-emerald-600">+ 0.00</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="p-8">
                                    <div class="table-head grid grid-cols-5 p-4 text-[10px] font-black text-slate-400 uppercase tracking-widest">
                                        <div>Date</div>
                                        <div>Note</div>
                                        <div class="text-center">In (+)</div>
                                        <div class="text-right">Out (-)</div>
                                        <div class="text-right pdf-action-column">Actions</div>
                                    </div>
                                    <div id="detHistory" class="divide-y text-sm font-bold text-slate-700"></div>
                                    <div class="mt-8 pt-6 border-t border-dashed flex justify-between items-center opacity-40 grayscale">
                                        <p class="text-[10px] font-black uppercase">Generated by ScrapPro</p>
                                        <p id="pdfTime" class="text-[10px] font-bold"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="expensePDFContainer" class="hidden">
        <div id="expensePDFContent">
            <div class="statement-header p-8 pb-4">
                <p class="text-[11px] font-bold text-indigo-500 uppercase tracking-widest mb-4">Monthly Expense Report</p>
                <h2 id="expPDFMonthTitle" class="text-4xl font-black text-slate-800 mt-2 tracking-tight">Financial Summary</h2>
            </div>
            <div class="p-8" id="expensePDFList"></div>
        </div>
    </div>

    <script>
        let db = JSON.parse(localStorage.getItem('scrappro_db')) || { expenses: [], transactions: [] };
        let users = JSON.parse(localStorage.getItem('scrappro_users')) || [];
        let currentUser = localStorage.getItem('scrappro_logged_user');
        
        let laborMode = 'kg', editExpIndex = null, editTransId = null, activeTransType = 'credit', currentCurrency = '$';
        let authMode = 'login';

        function saveDB() { localStorage.setItem('scrappro_db', JSON.stringify(db)); }
        
        // --- AUTH LOGIC ---
        function toggleAuthMode() {
            authMode = authMode === 'login' ? 'register' : 'login';
            document.getElementById('auth-title').innerText = authMode === 'login' ? 'Login to Account' : 'Create New Account';
            document.getElementById('auth-btn').innerText = authMode === 'login' ? 'Login' : 'Register';
            document.getElementById('auth-toggle-text').innerText = authMode === 'login' ? "Don't have an account?" : "Already have an account?";
            document.getElementById('auth-toggle-btn').innerText = authMode === 'login' ? "Register" : "Login";
        }

        function handleAuth() {
            const user = document.getElementById('auth-user').value.trim();
            const pass = document.getElementById('auth-pass').value.trim();
            if(!user || !pass) return alert("Please fill fields");

            if(authMode === 'register') {
                if(users.find(u => u.user === user)) return alert("User already exists");
                users.push({user, pass});
                localStorage.setItem('scrappro_users', JSON.stringify(users));
                alert("Account created! Please login.");
                toggleAuthMode();
            } else {
                const found = users.find(u => u.user === user && u.pass === pass);
                if(found) {
                    localStorage.setItem('scrappro_logged_user', user);
                    initApp();
                } else {
                    alert("Invalid credentials");
                }
            }
        }

        function logout() {
            localStorage.removeItem('scrappro_logged_user');
            location.reload();
        }

        function initApp() {
            if(localStorage.getItem('scrappro_logged_user')) {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                updateCurrency();
                calculate();
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('expDate').value = today;
                document.getElementById('transDate').value = today;
            }
        }

        function updateCurrency() {
            currentCurrency = document.getElementById('currency-select').value;
            calculate();
            if(!document.getElementById('view-ledger').classList.contains('hidden')) renderExpenses();
            if(!document.getElementById('view-parties').classList.contains('hidden')) renderParties();
        }

        function fmt(val) {
            return currentCurrency + " " + parseFloat(val).toLocaleString(undefined, {minimumFractionDigits: 2});
        }

        function switchTab(tab) {
            ['calc', 'ledger', 'parties'].forEach(t => {
                document.getElementById(`view-${t}`).classList.toggle('hidden', t !== tab);
                document.getElementById(`tab-${t}`).classList.toggle('active', t === tab);
            });
            if(tab === 'ledger') renderExpenses();
            if(tab === 'parties') renderParties();
        }

        // --- CALCULATOR LOGIC ---
        function setLaborMode(m) {
            laborMode = m;
            document.getElementById('btnKg').className = m === 'kg' ? 'flex-1 py-2 rounded-lg bg-white shadow-sm text-indigo-600' : 'flex-1 py-2 rounded-lg text-slate-500';
            document.getElementById('btnFixed').className = m === 'fixed' ? 'flex-1 py-2 rounded-lg bg-white shadow-sm text-indigo-600' : 'flex-1 py-2 rounded-lg text-slate-500';
            document.getElementById('laborLabel').innerText = m === 'kg' ? `Labor (${currentCurrency}/kg)` : 'Labor (Fixed)';
            calculate();
        }

        function addProductRow(name="", w="", r="") {
            const tr = document.createElement('tr');
            tr.className = "border-b border-slate-50 group";
            tr.innerHTML = `
                <td class="py-4"><input type="text" value="${name}" class="bg-transparent font-bold outline-none w-full" placeholder="Material..."></td>
                <td class="py-4"><input type="number" value="${w}" oninput="calculate()" class="w-20 bg-slate-50 rounded-lg p-2 text-center row-w outline-none" placeholder="0"></td>
                <td class="py-4"><input type="number" value="${r}" oninput="calculate()" class="w-20 bg-slate-50 rounded-lg p-2 text-center row-r outline-none" placeholder="Rate"></td>
                <td class="py-4 text-right font-black text-slate-800 row-total">0.00</td>
            `;
            document.getElementById('salesBody').appendChild(tr);
            calculate();
        }

        function calculate() {
            const rw = parseFloat(document.getElementById('rawWeight').value) || 0;
            const rr = parseFloat(document.getElementById('rawRate').value) || 0;
            const lab = parseFloat(document.getElementById('laborInput').value) || 0;
            const tra = parseFloat(document.getElementById('transport').value) || 0;
            const msc = parseFloat(document.getElementById('misc').value) || 0;

            const totalCost = (rw * rr) + (laborMode === 'kg' ? rw * lab : lab) + tra + msc;
            let totalSales = 0, totalW = 0;

            document.querySelectorAll('#salesBody tr').forEach(row => {
                const w = parseFloat(row.querySelector('.row-w').value) || 0;
                const r = parseFloat(row.querySelector('.row-r').value) || 0;
                const line = w * r;
                totalSales += line; totalW += w;
                row.querySelector('.row-total').innerText = fmt(line);
            });

            const profit = totalSales - totalCost;
            const margin = totalSales > 0 ? (profit / totalSales * 100).toFixed(1) : 0;
            const waste = rw > 0 ? ((rw - totalW) / rw * 100).toFixed(1) : 0;

            document.getElementById('grandTotalSales').innerText = fmt(totalSales);
            document.getElementById('displayCost').innerText = fmt(totalCost);
            document.getElementById('weightStats').innerText = `${totalW} / ${rw} kg`;
            document.getElementById('wasteText').innerText = waste + "%";
            document.getElementById('marginText').innerText = margin + "%";
            
            const pText = document.getElementById('finalProfit');
            pText.innerText = (profit >= 0 ? "+ " : "- ") + fmt(Math.abs(profit));
            pText.className = `text-7xl font-black transition-all ${profit >= 0 ? 'text-emerald-600' : 'text-rose-600'}`;
            
            const tag = document.getElementById('statusTag');
            tag.innerText = profit >= 0 ? 'Profitable' : 'Loss Detected';
            tag.className = `inline-block mt-4 px-4 py-1 rounded-full text-[10px] font-black uppercase ${profit >= 0 ? 'bg-emerald-100 text-emerald-600' : 'bg-rose-100 text-rose-600'}`;
        }

        // --- EXPENSES LOGIC ---
        function addExpense() {
            const date = document.getElementById('expDate').value;
            const title = document.getElementById('expTitle').value;
            const amount = parseFloat(document.getElementById('expAmount').value) || 0;
            if(!title || amount <= 0) return;

            if(editExpIndex !== null) {
                db.expenses[editExpIndex] = { date, title, amount };
                editExpIndex = null;
                document.getElementById('saveExpBtn').innerText = "Save Expense";
            } else {
                db.expenses.push({ date, title, amount });
            }
            saveDB();
            document.getElementById('expTitle').value = ''; 
            document.getElementById('expAmount').value = '';
            renderExpenses();
        }

        function renderExpenses() {
            const list = document.getElementById('ledgerList');
            list.innerHTML = '';
            const months = {};
            
            // Sort expenses by date
            const sorted = [...db.expenses].sort((a,b) => new Date(b.date) - new Date(a.date));

            sorted.forEach((ex) => {
                const originalIdx = db.expenses.indexOf(ex);
                const m = new Date(ex.date).toLocaleString('default', { month: 'long', year: 'numeric' }).toUpperCase();
                if(!months[m]) months[m] = { items: [], total: 0 };
                months[m].items.push({...ex, originalIdx});
                months[m].total += ex.amount;
            });

            Object.keys(months).forEach(m => {
                let html = `
                <div class="card p-8">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h3 class="font-extrabold text-slate-800 text-lg tracking-tight">${m}</h3>
                            <span class="bg-rose-50 text-rose-500 px-3 py-1 rounded-full text-[10px] font-black uppercase mt-2 inline-block">Total: - ${fmt(months[m].total)}</span>
                        </div>
                        <button onclick="downloadMonthPDF('${m}')" class="text-[10px] bg-indigo-50 text-indigo-600 px-3 py-2 rounded-lg font-bold"><i class="fas fa-file-pdf mr-1"></i> PDF</button>
                    </div>
                    <div class="space-y-4">`;
                months[m].items.forEach(item => {
                    html += `<div class="flex justify-between items-center p-4 bg-slate-50 rounded-xl">
                        <div><p class="font-bold text-slate-700">${item.title}</p><p class="text-[10px] text-slate-400 font-bold">${item.date}</p></div>
                        <div class="flex items-center gap-4">
                            <span class="font-black text-slate-800">${fmt(item.amount)}</span>
                            <button onclick="editExpense(${item.originalIdx})" class="text-amber-500"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteExpense(${item.originalIdx})" class="text-rose-400"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`;
                });
                html += `</div></div>`;
                list.insertAdjacentHTML('beforeend', html);
            });
        }

        function editExpense(idx) {
            const ex = db.expenses[idx];
            document.getElementById('expDate').value = ex.date;
            document.getElementById('expTitle').value = ex.title;
            document.getElementById('expAmount').value = ex.amount;
            editExpIndex = idx;
            document.getElementById('saveExpBtn').innerText = "Update Expense";
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function deleteExpense(idx) {
            if(confirm("Delete?")) { db.expenses.splice(idx, 1); saveDB(); renderExpenses(); }
        }

        function downloadMonthPDF(monthName) {
            const container = document.getElementById('expensePDFList');
            document.getElementById('expPDFMonthTitle').innerText = monthName;
            
            // Filter only this month items
            const filteredExpenses = db.expenses.filter(ex => 
                new Date(ex.date).toLocaleString('default', { month: 'long', year: 'numeric' }).toUpperCase() === monthName
            ).sort((a,b) => new Date(a.date) - new Date(b.date));

            let html = `<div class="space-y-4">`;
            filteredExpenses.forEach(ex => {
                html += `<div class="flex justify-between items-center p-4 border-b">
                    <div><p class="font-bold text-slate-700">${ex.title}</p><p class="text-[10px] text-slate-400 font-bold">${ex.date}</p></div>
                    <span class="font-black text-slate-800">${fmt(ex.amount)}</span>
                </div>`;
            });
            html += `</div>`;
            container.innerHTML = html;

            const element = document.getElementById('expensePDFContent');
            const opt = { margin: 0.5, filename: `Expenses_${monthName}.pdf`, html2canvas: { scale: 3 }, jsPDF: { unit: 'in', format: 'a4' } };
            html2pdf().set(opt).from(element).save();
        }

        // --- PARTIES LOGIC ---
        function setTransType(t) {
            activeTransType = t;
            document.getElementById('typeCredit').className = t === 'credit' ? 'flex-1 py-3 rounded-xl font-bold bg-emerald-500 text-white shadow-lg shadow-emerald-100' : 'flex-1 py-3 rounded-xl font-bold border-2 border-emerald-500 text-emerald-500';
            document.getElementById('typeDebit').className = t === 'debit' ? 'flex-1 py-3 rounded-xl font-bold bg-rose-500 text-white shadow-lg shadow-rose-100' : 'flex-1 py-3 rounded-xl font-bold border-2 border-rose-500 text-rose-500';
        }

        function addTransaction() {
            const date = document.getElementById('transDate').value, 
                  name = document.getElementById('transName').value.trim(), 
                  role = document.getElementById('transRole').value, 
                  amount = parseFloat(document.getElementById('transAmount').value) || 0, 
                  note = document.getElementById('transNote').value;
            
            if(!name || amount <= 0) return;

            if(editTransId !== null) {
                const idx = db.transactions.findIndex(t => t.id === editTransId);
                db.transactions[idx] = { ...db.transactions[idx], date, name, role, type: activeTransType, amount, note };
                editTransId = null;
            } else {
                db.transactions.push({ id: Date.now(), date, name, role, type: activeTransType, amount, note });
            }
            
            saveDB();
            resetTransForm();
            renderParties();
            if(!document.getElementById('partyDetailView').classList.contains('hidden')) {
                viewParty(name);
            }
        }

        function resetTransForm() {
            editTransId = null;
            document.getElementById('transAmount').value = ''; 
            document.getElementById('transNote').value = '';
            document.getElementById('entryFormTitle').innerText = "Add New Entry";
            document.getElementById('saveTransBtn').innerText = "Save Entry";
            document.getElementById('cancelTransEdit').classList.add('hidden');
            document.getElementById('transName').readOnly = false;
            document.getElementById('transRole').disabled = false;
        }

        function renderParties() {
            const container = document.getElementById('partiesContainer'), search = document.getElementById('searchParty').value.toLowerCase();
            const parties = {};
            let totalRec = 0, totalPay = 0;
            
            db.transactions.forEach(t => {
                if(!parties[t.name]) parties[t.name] = { role: t.role, balance: 0 };
                parties[t.name].balance += (t.type === 'credit' ? t.amount : -t.amount);
            });

            container.innerHTML = '';
            Object.keys(parties).forEach(name => {
                const p = parties[name];
                if(p.balance > 0) totalRec += p.balance; else totalPay += Math.abs(p.balance);
                
                if(name.toLowerCase().includes(search)) {
                    container.innerHTML += `
                    <div onclick="viewParty('${name}')" class="card p-5 flex justify-between items-center cursor-pointer hover:border-indigo-200 transition-all">
                        <div>
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">${p.role}</p>
                            <h4 class="font-extrabold text-slate-800">${name}</h4>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] font-bold text-slate-400 uppercase">Balance</p>
                            <p class="font-black ${p.balance >= 0 ? 'text-emerald-600' : 'text-rose-600'}">${fmt(Math.abs(p.balance))}</p>
                        </div>
                    </div>`;
                }
            });
            document.getElementById('statReceivable').innerText = fmt(totalRec);
            document.getElementById('statPayable').innerText = fmt(totalPay);
            document.getElementById('statNet').innerText = fmt(totalRec - totalPay);
        }

        function viewParty(name) {
            const history = db.transactions.filter(t => t.name === name).sort((a,b) => new Date(a.date) - new Date(b.date));
            const role = history[0].role;
            let balance = 0;

            // Auto-fill form for this party
            document.getElementById('transName').value = name;
            document.getElementById('transRole').value = role;
            document.getElementById('transName').readOnly = true;
            document.getElementById('transRole').disabled = true;

            document.getElementById('partyListView').classList.add('hidden');
            document.getElementById('partyDetailView').classList.remove('hidden');
            document.getElementById('detName').innerText = name;
            document.getElementById('detRole').innerText = role;

            const list = document.getElementById('detHistory');
            list.innerHTML = '';
            history.forEach(t => {
                balance += (t.type === 'credit' ? t.amount : -t.amount);
                list.innerHTML += `
                <div class="grid grid-cols-5 p-4 items-center">
                    <div class="text-slate-400 text-[11px]">${t.date}</div>
                    <div class="font-bold">${t.note || '-'}</div>
                    <div class="text-center text-emerald-600">${t.type === 'credit' ? fmt(t.amount) : ''}</div>
                    <div class="text-right text-rose-500">${t.type === 'debit' ? fmt(t.amount) : ''}</div>
                    <div class="text-right flex justify-end gap-2 pdf-action-column">
                        <button onclick="editTransaction(${t.id})" class="text-amber-500 p-1"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteTransaction(${t.id})" class="text-rose-400 p-1"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            });

            document.getElementById('detBalance').innerText = (balance >= 0 ? '+ ' : '- ') + fmt(Math.abs(balance));
            document.getElementById('detBalance').className = `text-3xl font-black ${balance >= 0 ? 'text-emerald-600' : 'text-rose-600'}`;
        }

        function editTransaction(id) {
            const t = db.transactions.find(item => item.id === id);
            document.getElementById('transDate').value = t.date;
            document.getElementById('transName').value = t.name;
            document.getElementById('transRole').value = t.role;
            document.getElementById('transAmount').value = t.amount;
            document.getElementById('transNote').value = t.note;
            setTransType(t.type);
            
            editTransId = id;
            document.getElementById('entryFormTitle').innerText = "Edit Entry";
            document.getElementById('saveTransBtn').innerText = "Update Entry";
            document.getElementById('cancelTransEdit').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function deleteTransaction(id) {
            if(confirm("Delete this transaction?")) {
                const name = db.transactions.find(t => t.id === id).name;
                db.transactions = db.transactions.filter(t => t.id !== id);
                saveDB();
                renderParties();
                const remaining = db.transactions.filter(t => t.name === name);
                if(remaining.length > 0) viewParty(name);
                else backToParties();
            }
        }

        function backToParties() {
            resetTransForm();
            document.getElementById('partyListView').classList.remove('hidden');
            document.getElementById('partyDetailView').classList.add('hidden');
            document.getElementById('transName').value = '';
            document.getElementById('transName').readOnly = false;
            document.getElementById('transRole').disabled = false;
        }

        function downloadPDF() {
            document.getElementById('pdfTime').innerText = "Generated: " + new Date().toLocaleString();
            const element = document.getElementById('pdfExportContent');
            
            // Add class to hide actions during PDF generation
            const actionCols = document.querySelectorAll('.pdf-action-column');
            actionCols.forEach(el => el.style.display = 'none');

            const opt = { 
                margin: 0.3, 
                filename: document.getElementById('detName').innerText + '_Statement.pdf', 
                html2canvas: { scale: 3 }, 
                jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' } 
            };

            html2pdf().set(opt).from(element).save().then(() => {
                actionCols.forEach(el => el.style.display = '');
            });
        }

        window.onload = initApp;
    </script>
</body>
</html>